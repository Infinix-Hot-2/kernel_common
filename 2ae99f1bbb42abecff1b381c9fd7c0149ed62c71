{
  "comments": [
    {
      "key": {
        "uuid": "06318aec_8f71d9fc",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1000205
      },
      "writtenOn": "2016-10-27T20:23:37Z",
      "side": 1,
      "message": "How safe is this before destroying the workqueue?",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "011ed449_a4f582d9",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1013030
      },
      "writtenOn": "2016-10-27T20:34:01Z",
      "side": 1,
      "message": "mmm the workqueue is not related to binder_device, right? And since this is init(), I\u0027m not sure we could have posted any work to the workqueue yet? I probably miss what you\u0027re trying to say..",
      "parentUuid": "06318aec_8f71d9fc",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "06318aec_af081507",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1000205
      },
      "writtenOn": "2016-10-27T20:37:33Z",
      "side": 1,
      "message": "Once the misc device is posted, someone could theoretically open it and queue work that access the structure you free here. I don\u0027t know if misc_deregister waits for all that work to complete before it returns. If it does, or the remaining work does not access that data you free, then it should be safe as is.",
      "parentUuid": "011ed449_a4f582d9",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "011ed449_04e57622",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1013030
      },
      "writtenOn": "2016-10-27T20:46:30Z",
      "side": 1,
      "message": "Mmm I don\u0027t know enough about the kernel init procedure. Can userspace even call open() before all drivers have completed init()? I usually see binder init complete within 3 seconds of kernel start, well before userspace init is even executed. But I\u0027m not sure this is guaranteed.\n\nHow could misc_deregister() wait for work to complete - it doesn\u0027t know about it?",
      "parentUuid": "06318aec_af081507",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "06318aec_f2ede04d",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1000205
      },
      "writtenOn": "2016-10-27T21:21:50Z",
      "side": 1,
      "message": "misc_deregister would not wait directly fro work to complete, but it may wait for close to finish. In this case I don\u0027t think it will wait though as binder_release just queues more work. I don\u0027t know if this init function is guaranteed to complete before user-space starts.",
      "parentUuid": "011ed449_04e57622",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "011ed449_a45ae209",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1013030
      },
      "writtenOn": "2016-10-27T21:40:29Z",
      "side": 1,
      "message": "I think init is guaranteed to complete, but double checking. Of course if this driver is loaded as a module it\u0027s still a race.\n\nI guess I could just first call destroy_workqueue(), since that appears to wait until all work is done. It just makes this code a bit more ugly.",
      "parentUuid": "06318aec_f2ede04d",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "06318aec_55d13eb3",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1000205
      },
      "writtenOn": "2016-10-27T21:45:39Z",
      "side": 1,
      "message": "This driver cannot be loaded as a module so I would not worry about that. If you plan to make the param write-able this race would have to be avoided. Another option is to not destroy instances that initialized when another instance fails although that would mean that you have to return success from init even if it was not fully successful.",
      "parentUuid": "011ed449_a45ae209",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "213cb8a3_7088aeab",
        "filename": "drivers/android/binder.c",
        "patchSetId": 14
      },
      "lineNbr": 3959,
      "author": {
        "id": 1013030
      },
      "writtenOn": "2016-10-27T21:53:33Z",
      "side": 1,
      "message": "Not planning on making it writable, and I looked at the init code and think we\u0027re safe.\n\ninit/main.c:\n\nkernel_init()\n  --\u003ekernel_init_freeable()\n    --\u003edo_basic_setup()\n      --\u003edo_initcalls()\n  ..start userspace init\n\nthe binder driver is initialized as part of do_initcalls().",
      "parentUuid": "06318aec_55d13eb3",
      "revId": "2ae99f1bbb42abecff1b381c9fd7c0149ed62c71",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}