{
  "comments": [
    {
      "key": {
        "uuid": "44141a88_13139668",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T00:35:07Z",
      "side": 1,
      "message": "No, please use locking here always. The user in thins file that previously called wl_update_wiphybands() with cfg !\u003d NULL (and thus did not use locking) should be calling __wl_update_wiphybands() now.",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44141a88_133276bf",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T01:36:18Z",
      "side": 1,
      "message": "Once I tried to set locking always, but it failed to power up WiFi. because failed getting usr_sync lock. \n\nIn the original code, it reassign cfg pointer to global one if passed value was NULL. and set mutex for some reason. \n\n\tif (cfg \u003d\u003d NULL) {\n\t\tcfg \u003d g_bcm_cfg;\n\t\tmutex_lock(\u0026cfg-\u003eusr_sync);\n\t\trollback_lock \u003d true;\n\t}\n\nI think we can skip to call __wl_update_wiphybands when cfg\u003d\u003dNULL, then setting mutex is not needed.",
      "parentUuid": "44141a88_13139668",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44141a88_7ed0d131",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T05:08:41Z",
      "side": 1,
      "message": "If you did that without adjusting caller in this file to use non-locking version then it is not a surprise: you\u0027d try to take this mutex recursively and woudl deadlock.\n\nI am not sure about dropping call to __wl_update_wiphybands(), I\u0027d rather did it in a separate CL.",
      "parentUuid": "44141a88_133276bf",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44141a88_fefa01aa",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T05:42:31Z",
      "side": 1,
      "message": "Yes, your saying correct. If in case cfg\u003d\u003dNULL passing, then there\u0027s nothing that we can do update through wiphybands. I think tt\u0027s better to see with further test result.",
      "parentUuid": "44141a88_7ed0d131",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "240f267a_374b20a1",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T06:46:02Z",
      "side": 1,
      "message": "But we never pass cfg\u003d\u003dNULL to wl_update_wiphybands() anymore. Please restore locking, I assume it was there on purpose. If locking is not needed please submit a separate CL describing why it is not needed, as a followup for this one.",
      "parentUuid": "44141a88_fefa01aa",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e486eed4_a3fdb0aa",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T17:27:20Z",
      "side": 1,
      "message": "@Dmitry Torokhov\nIf we want to set mutex here, usr_sync is not appropriate. usr_sync is normally used for user action for scan. I\u0027m trying to find existing another one for use, but I think we should create new one if definitely needed.",
      "parentUuid": "240f267a_374b20a1",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "04cce27b_e9428674",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T17:50:20Z",
      "side": 1,
      "message": "We *were* using usr_sync mutex here. If it is not needed/incorrect, please remove it in a separate CL, with explanation why it is not needed and why it is safe to remove it. Or change it for a different mutex if you think that usr_sync is not the rightmutex to use. Again, in a different CL, with detailed explanation.\n\nMoreover, looking at the driver wl_update_wiphybands() is called from dhd_bus_country_set() and dhd_bus_band_set() and I do not see anything that would prevent these 2 from being called simultaneously from different threads. So a mutex is needed there.",
      "parentUuid": "e486eed4_a3fdb0aa",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6492fe15_900ebd3e",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1000414
      },
      "writtenOn": "2015-09-04T18:25:56Z",
      "side": 1,
      "message": "@Dmitry, but locking used only in case of cfg \u003d\u003d NULL, and now we are not calling __wl_update_wiphybands() in this case",
      "parentUuid": "04cce27b_e9428674",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e486eed4_e37e58ef",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T18:59:37Z",
      "side": 1,
      "message": "Yes, agreed to Dmtiry Shmidt. Mutex was used only when cfg\u003d\u003dNULL case.",
      "parentUuid": "6492fe15_900ebd3e",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44141a88_b9bc2342",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T19:03:36Z",
      "side": 1,
      "message": "@Dmitry Shmidt:\n\nWe are not calling wl_update_wiphybands() with NULL cfg anymore, that was the whole point of this change - to always supply valid cfg pointer instead of relying on the global one.\n\nThe old locking logic was: if wl_update_wiphybands() is called with cfg \u003d\u003d NULL assume external caller and lock the usr_sync mutex and do the work. If cfg !\u003d NULL assume internal caller and assume that mutex is already taken.\n\n@Insun: What I am asking is splitting wl_update_wiphybands() into 2: __wl_update_wiphybands() that does the work itself and does not do any locking. It should be used by the internal to wl_cfg80211.c callers (__wl_cfg80211_up) that have already taken usr_sync mutex.\n\nwl_update_wiphybands() should unconditionally take the lock and call __wl_update_wiphybands() to perform the work:\n\ns32 wl_update_wiphybands(struct bcm_cfg80211 *cfg, bool notify)\n{\n    s32 err;\n\n    mutex_lock(\u0026cfg-\u003eusr_sync);\n    err \u003d __wl_update_wiphybands(cfg, notify);\n    mutex_unlock(\u0026cfg-\u003eusr_sync);\n\n    return err;\n}\n\nThe \"non underscore\" function should be used by external callers.\n\nHope this helps.",
      "parentUuid": "6492fe15_900ebd3e",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8497f201_497404c8",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.c",
        "patchSetId": 6
      },
      "lineNbr": 11453,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T22:09:22Z",
      "side": 1,
      "message": "@Dmitry Torokhov. \nThanks for plentiful explain. I just added new mutex wiphy_sync for this purpose. I tested it works OK.",
      "parentUuid": "44141a88_b9bc2342",
      "range": {
        "startLine": 11447,
        "startChar": 0,
        "endLine": 11453,
        "endChar": 2
      },
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "84529221_51481526",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.h",
        "patchSetId": 6
      },
      "lineNbr": 914,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T00:35:07Z",
      "side": 1,
      "message": "I do not think you need to export this one.",
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6492fe15_15185faf",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.h",
        "patchSetId": 6
      },
      "lineNbr": 914,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T01:36:18Z",
      "side": 1,
      "message": "Yes agreed. Fixed.",
      "parentUuid": "84529221_51481526",
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "84529221_b41cd700",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.h",
        "patchSetId": 6
      },
      "lineNbr": 914,
      "author": {
        "id": 1076784
      },
      "writtenOn": "2015-09-04T05:11:44Z",
      "side": 1,
      "message": "No it is not. You still have __wl_update_wiphybands() as a global function. It should be static to wl_cfg80211.c",
      "parentUuid": "6492fe15_15185faf",
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "644d9e85_b8c3b8be",
        "filename": "drivers/net/wireless/bcmdhd/wl_cfg80211.h",
        "patchSetId": 6
      },
      "lineNbr": 914,
      "author": {
        "id": 1072843
      },
      "writtenOn": "2015-09-04T05:42:31Z",
      "side": 1,
      "message": "Oh..Ok. moved to .c file.",
      "parentUuid": "84529221_b41cd700",
      "revId": "a98c0f4a7ffcf0801a87427976b1f10f54ec0ebb",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}